<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åº«å­˜ç›¤é»è¡¨</title>
<style>
  /* --- å…¨å±€è¨­å®š --- */
  * { box-sizing: border-box; }
  body { 
    font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
    margin: 0; 
    background-color: #555; /* ç¶²é èƒŒæ™¯æ·±ç°ï¼Œå‡¸é¡¯A4ç™½ç´™ */
    padding: 20px;
  }

  /* --- A4 ç´™å¼µæ¨¡æ“¬å€ (æ¯ä¸€é å°±æ˜¯ä¸€å€‹ .page-container) --- */
  .page-container {
    width: 210mm; /* A4 å¯¬åº¦ */
    min-height: 297mm; /* A4 é«˜åº¦ */
    background: white;
    margin: 0 auto 20px auto; /* é èˆ‡é ä¹‹é–“ç•™ç©ºéš™ */
    padding: 10mm 15mm; /* å…§ç¸®é‚Šç•Œï¼Œç¢ºä¿åˆ—å°ä¸åˆ‡é‚Š */
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    position: relative;
    page-break-after: always; /* é—œéµï¼šå°å®Œé€™å¼µå¼·åˆ¶æ›é  */
  }
  
  /* --- æ¨™é¡Œå€ (ä¿®æ­£ï¼šæ¨™é¡Œèˆ‡æ—¥æœŸåˆ†é–‹) --- */
  .header-section {
    position: relative;
    margin-bottom: 10px;
    border-bottom: 2px solid #000;
    padding-bottom: 5px;
    height: 80px; /* å›ºå®šé«˜åº¦ï¼Œç¢ºä¿ä¸æ“ å£“ */
  }

  .main-title {
    font-family: "Kaiti TC", "STKaiti", "BiauKai", "æ¨™æ¥·é«”", serif; 
    font-size: 42px; 
    font-weight: 900;
    text-align: center;
    line-height: 1;
    margin: 0;
    padding-top: 5px;
  }

  .date-section {
    position: absolute;
    right: 0;
    bottom: 5px; /* å›ºå®šåœ¨æ¨™é¡Œå€åº•éƒ¨ */
    font-size: 16px;
    font-weight: bold;
    color: #000;
  }
  
  .date-line {
    display: inline-block;
    width: 120px;
    border-bottom: 1px solid #000;
  }

  /* --- è­¦èª --- */
  .slogan {
    text-align: center;
    color: #d9534f;
    font-weight: bold;
    font-size: 18px;
    margin: 5px 0 10px 0;
    padding: 2px;
    border: 1px dashed #d9534f;
  }

  /* --- è¡¨æ ¼è¨­å®š --- */
  table {
    width: 100%;
    border-collapse: collapse;
    border: 2px solid #000; /* å¤–æ¡†åŠ ç²— */
    table-layout: fixed; 
  }
  
  th, td {
    border: 1px solid #000; /* â˜…æ¯ä¸€æ ¼éƒ½æœ‰ç·š */
    font-size: 18px;
    color: #000;
    vertical-align: middle;
    padding: 0; 
    height: 48px; /* â˜…ç²¾ç®—é«˜åº¦ï¼šA4æ‰£æ‰æ¨™é¡Œï¼Œé™¤ä»¥16æ ¼ç´„48-50px */
    overflow: hidden;
  }

  /* --- æ¬„ä½å¯¬åº¦ --- */
  .col-name { width: 44%; padding: 0 5px; font-weight: bold; font-size: 18px; line-height: 1.2; text-align: left;}
  .col-box-h { width: 16%; } /* æ¨™é¡Œæ¬„å¯¬ */
  .col-pack-h { width: 16%; }
  .col-date { width: 24%; text-align: center; font-size: 16px; }

  /* --- åˆ†å‰²æ ¼ (æ•¸é‡æ¬„) --- */
  .split-box {
    display: flex;
    width: 100%;
    height: 100%; 
  }
  
  .split-left {
    flex-grow: 1; 
    background-color: #fff;
    border-right: 1px solid #000; /* â˜…ä¸­é–“çš„åˆ†éš”ç·š */
  }

  .split-right {
    width: 45px; 
    text-align: center;
    font-size: 14px;
    font-weight: bold;
    background-color: #eee; 
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-print-color-adjust: exact; /* å¼·åˆ¶å°å‡ºèƒŒæ™¯è‰² */
  }

  /* --- è¡¨é ­ --- */
  .header-row td {
    background-color: #333;
    color: white;
    text-align: center;
    font-weight: normal;
    font-size: 16px;
    height: 35px; /* è¡¨é ­å¯ä»¥çŸ®ä¸€é» */
    -webkit-print-color-adjust: exact;
  }

  /* --- åŠŸèƒ½å€ --- */
  .no-print { text-align: center; margin-bottom: 20px; padding: 10px; background: white; }
  .btn-refresh { padding: 10px 25px; background: #0056b3; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
  #loading, #error { background: white; padding: 20px; text-align: center; }

  /* --- åˆ—å°å°ˆç”¨è¨­å®š --- */
  @media print {
    body { background: white; padding: 0; margin: 0; }
    .page-container {
      width: 100%;
      height: 100%; 
      margin: 0; 
      padding: 0; /* åˆ—å°æ™‚ç”±ç€è¦½å™¨æ§åˆ¶é‚Šç•Œï¼Œé€™è£¡æ­¸é›¶ */
      box-shadow: none;
      page-break-after: always;
      border: none;
    }
    /* æœ€å¾Œä¸€é ä¸è¦å¤šå‡ºä¸€å¼µç©ºç™½ç´™ */
    .page-container:last-child { page-break-after: auto; }
    .no-print { display: none !important; }
  }
</style>
</head>
<body>

<div class="no-print">
  <button class="btn-refresh" onclick="location.reload()">ğŸ”„ é‡æ–°è®€å–è³‡æ–™</button>
  <div style="margin-top:5px; color:#666; font-size:14px;">å»ºè­°ä½¿ç”¨ Chrome ç€è¦½å™¨ï¼ŒæŒ‰ Ctrl+P åˆ—å°ï¼Œé‚Šç•Œè¨­ç‚ºã€Œç„¡ã€æˆ–ã€Œé è¨­ã€</div>
</div>

<div id="loading">è®€å– Google Sheet ä¸­...</div>
<div id="error" style="display:none; color:red;">è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–æ¬Šé™ã€‚</div>

<div id="printArea"></div>

<script>
  // è¨­å®šæ¯é å¹¾ç­†è³‡æ–™
  const ITEMS_PER_PAGE = 16;

  function loadData() {
    google.script.run.withSuccessHandler(renderPages).withFailureHandler(showError).getSheetData();
  }

  function renderPages(rows) {
    const printArea = document.getElementById('printArea');
    printArea.innerHTML = ''; // æ¸…ç©º
    
    // 1. å–å¾—æ¨™é¡Œ (Row 0)
    let sheetTitle = "åº«å­˜è¡¨";
    if (rows.length > 0 && rows[0][0]) {
      sheetTitle = rows[0][0];
    }

    // 2. æ•´ç†æœ‰æ•ˆè³‡æ–™ (å»é™¤ç©ºè¡Œ)
    let validItems = [];
    // å¾ç¬¬3åˆ— (Index 2) é–‹å§‹æŠ“
    for (let i = 2; i < rows.length; i++) {
      let row = rows[i];
      // ç°¡å–®åˆ¤æ–·ï¼šåªè¦å“åä¸ç‚ºç©ºï¼Œå°±ç®—ä¸€ç­†
      if (row[0] && row[0].trim() !== "") {
        let name = row[0];
        // æŠ“æ•ˆæœŸ
        let exp = "";
        if (row.length > 6) exp = row[6];
        else if (row.length > 5) exp = row[5];
        if(exp && exp.length > 10) exp = exp.substring(0, 10); // æˆªæ–·æ™‚é–“

        validItems.push({ name: name, exp: exp });
      }
    }

    // 3. è¨ˆç®—éœ€è¦å¹¾é 
    // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œè‡³å°‘è¦é¡¯ç¤ºä¸€é ç©ºè¡¨æ ¼
    let totalItems = validItems.length;
    let totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
    if (totalPages === 0) totalPages = 1;

    // 4. é–‹å§‹ç”¢ç”Ÿæ¯ä¸€é çš„ HTML
    for (let p = 0; p < totalPages; p++) {
      // å»ºç«‹é é¢å®¹å™¨
      let pageDiv = document.createElement('div');
      pageDiv.className = 'page-container';

      // é é¦– HTML
      let headerHtml = `
        <div class="header-section">
          <h1 class="main-title">${sheetTitle}</h1>
          <div class="date-section">
            å¡«è¡¨æ—¥æœŸï¼š<span class="date-line"></span>
            <span style="font-size:12px; font-weight:normal; margin-left:10px;">(ç¬¬ ${p+1}/${totalPages} é )</span>
          </div>
        </div>
        <div class="slogan">â€» å‡ºå…¥åº«è«‹å‹™å¿…æ›´æ”¹æ•¸é‡ â€»</div>
        <table>
          <thead>
            <tr class="header-row">
              <td class="col-name">å“å</td>
              <td class="col-box-h">æ•¸é‡ï¼ˆç®±ï¼‰</td>
              <td class="col-pack-h">æ•¸é‡ï¼ˆåŒ…ï¼ç›’ï¼‰</td>
              <td class="col-date">æœ€çŸ­æ•ˆæœŸ</td>
            </tr>
          </thead>
          <tbody>
      `;

      // ç”¢ç”Ÿ 16 åˆ—è³‡æ–™
      let rowsHtml = '';
      for (let i = 0; i < ITEMS_PER_PAGE; i++) {
        let dataIndex = p * ITEMS_PER_PAGE + i;
        let item = validItems[dataIndex];
        
        if (item) {
          // æœ‰è³‡æ–™çš„åˆ—
          rowsHtml += `
            <tr>
              <td class="col-name">${item.name}</td>
              <td><div class="split-box"><div class="split-left"></div><div class="split-right">ç®±</div></div></td>
              <td><div class="split-box"><div class="split-left"></div><div class="split-right">åŒ…/ç›’</div></div></td>
              <td class="col-date">${item.exp}</td>
            </tr>
          `;
        } else {
          // ç©ºç™½åˆ— (è£œæ»¿ 16 æ ¼ç”¨)
          rowsHtml += `
            <tr>
              <td class="col-name">&nbsp;</td>
              <td><div class="split-box"><div class="split-left"></div><div class="split-right">ç®±</div></div></td>
              <td><div class="split-box"><div class="split-left"></div><div class="split-right">åŒ…/ç›’</div></div></td>
              <td class="col-date"></td>
            </tr>
          `;
        }
      }

      // çµ„åˆ HTML
      pageDiv.innerHTML = headerHtml + rowsHtml + `</tbody></table>`;
      printArea.appendChild(pageDiv);
    }

    document.getElementById('loading').style.display = 'none';
  }

  function showError() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
  }

  // å•Ÿå‹•
  loadData();
</script>

</body>
</html>
